"use strict";var FunnyRain={};!function(n){Boplex.defineConstProp(n,"Version","0.0.1"),n.Physics={},n.Graphics={},n.Graphics.Widgets={},n.Plugins={},n.Plugins.Blocks={},n.Plugins.FallingThings={},n.Plugins.ScoreBoard={}}(FunnyRain),function(n){function t(o){function e(t){g=new n.Physics.RainWorld({onDestroyBody:f}),d=new n.Graphics.View,v=new n.Plugins.PluginManager(t),$(p).length>0&&($(p).append(d.getView()),y=new n.Graphics.AnimFrame(l,s),$(document).on("dblclick touchstart",r))}function i(n){if(!("clientX"in n)&&n.originalEvent.changedTouches)for(var t=n.originalEvent.changedTouches,o=0;o<t.length;o++){n.clientX=Math.round(t[o].pageX),n.clientY=Math.round(t[o].pageY);break}}function r(n){if(!h)return void c();i(n);var t=a(n.clientX,n.clientY);(!t||t&&B)&&u(),t&&t.onDblClick&&t.onDblClick(n)}function a(n,t){var o=g,e=o.findBody(n,t);return e?e.block:null}function c(){h=!0,B=!1,g.setIsPaused(!1),v.enable(!0)}function u(){B=!B,g.setIsPaused(!g.getIsPaused())}function l(n,t,o){d.setScale(n,t,o)}function s(){g.step(),v.step(),d.step()}function f(n,t){var o=t.block;o&&o.onDestroy&&o.onDestroy()}var p=o,y=null,d=null,g=null,h=!1,B=!1,v=null;e(this),t.prototype.getPluginManager=function(){return v},t.prototype.getView=function(){return d},t.prototype.getRainWorld=function(){return g},function(){v.load(),c()}()}n.Game=t}(FunnyRain),function(n){function t(n){function o(){var n=new Box2D.Common.Math.b2Vec2(v.gravity.x,v.gravity.y);h=new Box2D.Dynamics.b2World(n,!0)}function e(n){return n/v.RATIO}function i(n){var t={width:50,height:50,x:0,y:-60,restitution:.3,friction:10,density:1},o=$.extend({},t,n),i=new Box2D.Dynamics.b2BodyDef;i.type=Box2D.Dynamics.b2Body.b2_dynamicBody,i.position.Set(e(o.x),e(o.y));var r=h.CreateBody(i),a=new Box2D.Dynamics.b2FixtureDef;return a.shape=new Box2D.Collision.Shapes.b2PolygonShape,a.shape.SetAsBox(e(o.width),e(o.height)),a.density=o.density,a.restitution=o.restitution,a.friction=o.friction,r.CreateFixture(a),r}function r(n,t,o,e){var i=new Box2D.Dynamics.b2BodyDef;i.position.Set(n,t);var r=h.CreateBody(i),a=new Box2D.Dynamics.b2FixtureDef;return a.shape=new Box2D.Collision.Shapes.b2PolygonShape,a.shape.SetAsBox(o,e),a.density=1,r.CreateFixture(a),r}function a(){var n={timeStep:1/60,velocityIterations:8,positionIterations:4},t=n.timeStep;m&&(t=0),h.Step(t,n.velocityIterations,n.positionIterations),h.DrawDebugData(),h.ClearForces(),s()}function c(n){m=n}function u(){return m}function l(){return v.RATIO}function s(){x.forEach(function(n){h.DestroyBody(n)}),x=[]}function f(n){new Boplex.Event(null,P).raise(n),x.push(n)}function p(n,t){var o=new Box2D.Collision.b2AABB;return o.lowerBound.Set(n.x-t,n.y-t),o.upperBound.Set(n.x+t,n.y+t),o}function y(n,t){var o={size:v.bodySize},e=n.GetPosition();return t.x>=e.x&&t.x<=e.x+o.size&&t.y>=e.y&&t.y<=e.y+o.size}function d(n,t){var o,i={radius:v.bodySize},r=new Box2D.Common.Math.b2Vec2(e(n),e(t)),a=p(r,e(i.radius));return h.QueryAABB(function(n){var t=n.GetBody();return t.GetType()===Box2D.Dynamics.b2Body.b2_dynamicBody&&y(t,r)?(o=t,!1):!0},a),o}function g(n,t){function o(i){for(var r=i.GetContactList();r;){var a=r.other;!a.group&&t(a,n)&&(e.push(a),a.group=e,o(a)),r=r.next}}var e=[n];return n.group=e,o(n),e}var h,B=(new Boplex.Logger("FunnyRain.Physics.BaseWorld"),{RATIO:50,gravity:{x:0,y:0},onDestroyBody:null}),v=$.extend({},B,n),x=[],P=v.onDestroyBody,m=!1;o(),t.prototype.b2m=function(n){return e.call(this,n)},t.prototype.getBox2dWorld=function(){return h},t.prototype.setIsPaused=function(n){c.call(this,n)},t.prototype.getIsPaused=function(){return u.call(this)},t.prototype.step=function(){a.call(this)},t.prototype.getScale=function(){return l.call(this)},t.prototype.createWall=function(n,t,o,e){return r.call(this,n,t,o,e)},t.prototype.createDynamicBody=function(n){return i.call(this,n)},t.prototype.findBody=function(n,t){return d.call(this,n,t)},t.prototype.destroyBody=function(n){return f.call(this,n)},t.prototype.getMatchGroup=function(n,t){return g.call(this,n,t)}}n.Physics.BaseWorld=t}(FunnyRain),function(n){function t(o){function e(n){i(n)}function i(n){var t={wallSize:10,bottomPadding:100,leftPadding:0,rightPadding:100},o=n.b2m,e=n.createWall;e(0,o(c.canvasSize.y-t.bottomPadding),o(c.canvasSize.x),o(t.wallSize)),e(o(t.leftPadding),0,o(t.wallSize),o(c.canvasSize.y)),e(o(c.canvasSize.x-t.rightPadding),0,o(t.wallSize),o(c.canvasSize.y))}function r(n,t){var o={width:c.bodySize,height:c.bodySize,x:t||0,y:-60,restitution:.3,friction:10,density:1},e=n.createDynamicBody(o);return e}var a={canvasSize:{x:1600,y:1200},gravity:{x:0,y:9.8},bodySize:50},c=$.extend({},a,o);n.Physics.BaseWorld.call(this,c),e(this),t.prototype.createBody=function(n){return r.call(this,this,n)}}n.Physics.RainWorld=Boplex.inherit(t,n.Physics.BaseWorld)}(FunnyRain),function(n){function t(n,t,o){function e(){var n=$(window).innerWidth(),t=$(window).innerHeight();r(n,t)}function i(){requestAnimationFrame(i),c()}function r(n,t){var o=1,e=l.canvasSize,i=n/e.x,r=t/e.y;o=i>1||r>1?1:r>i?i:r;var c=o*e.x,u=o*e.y;a(o,c,u)}var a=n,c=t,u=(new Boplex.Logger("FunnyRain.AnimFrame"),{canvasSize:{x:1600,y:1200},dpr:window.devicePixelRatio}),l=$.extend({},u,o);!function(){i(),$(window).on("resize deviceOrientation",e),$(window).trigger("resize")}(),window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(n){window.setTimeout(n,1e3/60)}}()}n.Graphics.AnimFrame=t}(FunnyRain),function(n){function t(n){function o(n){var t=B.assetsDir+n+".png";return t}function e(){d=PIXI.autoDetectRenderer(B.canvasSize.x,B.canvasSize.y,{backgroundColor:B.backgroundColor}),g=a(B.backgroundImage),i()}function i(){}function r(n){var t=o(n),e=new PIXI.Sprite.fromImage(t);return e}function a(n){var t=r(n),o=new PIXI.Container;return o.addChild(t),o.sprite=t,o}function c(n){var t=a(n);return g.addChild(t),t}function u(n){if(n){var t=n.parent;t&&t.removeChild(n)}}function l(){return d.view}function s(n,t,o){g.scale.x=g.scale.y=n,d.resize(t,o)}function f(){d.render(g)}function p(n){return g.addChild(n),n}function y(n){u(n)}var d,g,h=(new Boplex.Logger("FunnyRain.Graphics.View"),{canvasSize:{x:1600,y:1200},backgroundColor:1087931,assetsDir:"assets/",backgroundImage:"background"}),B=$.extend({},h,n);e(),t.prototype.step=function(){f.call(this)},t.prototype.setScale=function(n,t,o){s.call(this,n,t,o)},t.prototype.getView=function(){return l.call(this)},t.prototype.createActor=function(n){return c.call(this,n)},t.prototype.destroyActor=function(n){return u.call(this,n)},t.prototype.createWidget=function(n){return p.call(this,n)},t.prototype.destroyWidget=function(n){return y.call(this,n)}}n.Graphics.View=t}(FunnyRain),function(n){function t(o){function e(){var n=i();f=f.concat(n)}function i(){var t=[new n.Plugins.ScoreBoard.ScoreBoardPlugin(s),new n.Plugins.Blocks.BlocksPlugin(s),new n.Plugins.FallingThings.FallingThingsPlugin(s)];return t}function r(n,t){for(var o=f.length,e=n?0:o-1,i=null;!i&&e>-1&&o>e;)i=t(f[e]),e=n?e+1:e-1;return i}function a(){r(!0,function(n){n.load&&n.load()})}function c(){r(!0,function(n){n.step&&n.step()})}function u(n){r(n,function(t){t.enable&&t.enable(n)})}function l(n){var t=r(!1,function(t){return n===t.getPluginId()?t:void 0});return t}var s=o,f=[];e(),t.prototype.load=function(){a.call(this)},t.prototype.step=function(){c.call(this)},t.prototype.enable=function(n){u.call(this,n)},t.prototype.findPlugin=function(n){return l.call(this,n)}}n.Plugins.PluginManager=t}(FunnyRain),function(n){function t(n,o){function e(n){return n._id}function i(){return r}this._id=n;var r=o;t.prototype.getPluginId=function(){return e.call(this,this)},t.prototype.getGame=function(){return i.call(this)}}n.Plugins.BasePlugin=t}(FunnyRain),function(n){function t(o){function e(t){i=new n.Plugins.Blocks.BlocksFactory(t.getGame())}n.Plugins.BasePlugin.call(this,"Blocks",o);var i=null;e(this),t.prototype.getBlocksFactory=function(){return i}}n.Plugins.Blocks.BlocksPlugin=Boplex.inherit(t,n.Plugins.BasePlugin)}(FunnyRain),function(n){function t(o){function e(){l=0}function i(n){for(var t=0;t<f.length;t++){var o=f[t];if(o.blockCategory===n)return o}return null}function r(n,t){var o=++l,e=new n.blockClass(o,s,n.blockTypes[t],n.blockCategory,function(n,t){u(t)});return p.push(e),e}function a(n){var t=Boplex.random(0,n.blockTypes.length-1);return r(n,t)}function c(n){var t=i(n);if(!t)throw new RangeError(n+" - unknown block category");return a(t)}function u(n){for(var t=0;t<p.length;t++)if(n===p[t]){p.splice(t,1);break}}var l,s=o,f=[{blockCategory:"fruit",blockClass:n.Plugins.Blocks.FruitBlock,blockTypes:["apple","peach","orange"]},{blockCategory:"bomb",blockClass:n.Plugins.Blocks.BombBlock,blockTypes:["bomb"]}],p=[];e(),t.prototype.createBlockByCategory=function(n){return c.call(this,n)},t.prototype.forEach=function(n){p.forEach(n)},t.prototype.destroyBlock=function(n){u.call(this,n)}}n.Plugins.Blocks.BlocksFactory=t}(FunnyRain),function(n){function t(n,o,e,i,r){function a(n,t,o,e,i){b=t,w=o,k=e,n.body=w.createBody(i),n.body.block=n,n.actor=k.createActor(n.type),n.adjust(),n.scheduleNextAction()}function c(n){var t=.2;n.actor.scale.x=n.actor.scale.y=t}function u(n,t,o){n.timeout=setTimeout(function(){b.getIsEnabled()&&(n.timeout=null,o(n))},t)}function l(n,t,o,e){var i=Boplex.random(t,o);u(n,i,e)}function s(n){var t={lifeTimeMin:1e4,lifeTimeMax:5e4};l(n,t.lifeTimeMin,t.lifeTimeMax,function(){return w.getIsPaused()?void s(n):void w.destroyBody(n.body)})}function f(n){s(n)}function p(n){y(n),d(n),new Boplex.Event(n,S).raise(n)}function y(n){var t=n.timeout;t&&clearTimeout(t)}function d(n){n.actor&&(k.destroyActor(n.actor),n.actor=null)}function g(n){if(n.body&&n.actor){var t=w.getScale(),o=n.body.GetPosition();n.actor.position.x=o.x*t,n.actor.position.y=o.y*t}}function h(n,t){B(n,t)}function B(n,t){n.isResolved;n.isResolved=!0;var o=v(n,t);o.forEach(function(n){w.destroyBody(n)});var e=m.getPluginManager().findPlugin("ScoreBoard");e.getScoreManager().changeScore(5*o.length)}function v(n,t){return w.getMatchGroup(n.body,function(t){return t.block?n.compareGroup(t.block):void 0})}function x(n,t){return n.type===t.type}function P(){return m}var m=o;this.type=e;this.body=null,this.actor=null;var b,w,k;this.timeout;var S=r;t.prototype.getGame=function(){return P.call(this)},t.prototype.install=function(n,t,o,e){a.call(this,this,n,t,o,e)},t.prototype.adjust=function(){c.call(this,this)},t.prototype.adjust=function(){c.call(this,this)},t.prototype.scheduleDestroy=function(){s.call(this,this)},t.prototype.scheduleNextAction=function(){f.call(this,this)},t.prototype.onDestroy=function(){p.call(this,this)},t.prototype.step=function(){g.call(this,this)},t.prototype.onDblClick=function(n){h.call(this,this,n)},t.prototype.compareGroup=function(n){return x.call(this,this,n)}}n.Plugins.Blocks.BaseBlock=t}(FunnyRain),function(n){function t(t,o,e,i,r){function a(n){n.scale=.2}n.Plugins.Blocks.BaseBlock.call(this,t,o,e,i,r),a(this)}n.Plugins.Blocks.FruitBlock=Boplex.inherit(t,n.Plugins.Blocks.BaseBlock)}(FunnyRain),function(n){function t(o,e,i,r,a){function c(n){n.actor.scale.x=n.actor.scale.y=.2,n.actor.sprite.rotation=-.05,TweenMax.to(n.actor.sprite,.1,{rotation:.05,yoyo:!0,repeat:-1}),TweenMax.to(n.actor.scale,.15,{x:.18,yoyo:!0,repeat:-1}),TweenMax.to(n.actor.scale,.15,{y:.18,yoyo:!0,repeat:-1})}n.Plugins.Blocks.BaseBlock.call(this,o,e,i,r,a),t.prototype.adjust=function(){c.call(this,this)}}n.Plugins.Blocks.BombBlock=Boplex.inherit(t,n.Plugins.Blocks.BaseBlock)}(FunnyRain),function(n){function t(o){function e(t){i=new n.Plugins.FallingThings.FallManager(t.getGame())}n.Plugins.BasePlugin.call(this,"FallingThings",o);var i=null;e(this),t.prototype.load=function(){i.load()},t.prototype.getFallManager=function(){return i},t.prototype.enable=function(n){i.enable(n)},t.prototype.step=function(){i.step()}}n.Plugins.FallingThings.FallingThingsPlugin=Boplex.inherit(t,n.Plugins.BasePlugin)}(FunnyRain),function(n){function t(n){function o(){}function e(){f=y.getRainWorld(),p=y.getView();var n=y.getPluginManager().findPlugin("Blocks");s=n.getBlocksFactory()}function i(){var n={bomb:25,max:100},t=Boplex.random(0,n.max);return t<n.bomb?"bomb":"fruit"}function r(n,t){var o=i(),e=s.createBlockByCategory(o);e.install(n,f,p,t)}function a(n){var t={fallWidth:1200,leftPadding:50,nextTimeMin:500,nextTimeMax:1e3},o=t.leftPadding+Boplex.random(0,t.fallWidth),e=Boplex.random(t.nextTimeMin,t.nextTimeMax);l&&(f.getIsPaused()||r(n,o),setTimeout(function(){a(n)},e))}function c(n,t){t!==l&&(l=t,l&&a(n))}function u(){s&&s.forEach(function(n){n.step()})}var l,s,f,p,y=n;o(),t.prototype.load=function(n){e.call(this)},t.prototype.enable=function(n){c.call(this,this,n)},t.prototype.getIsEnabled=function(){return l},t.prototype.step=function(){u.call(this)}}n.Plugins.FallingThings.FallManager=t}(FunnyRain),function(n){function t(){function n(){var n={textStyle:{font:"240px Courier Bold",strokeThickness:8,stroke:"white"},livesFill:"red",scoreFill:"green",scoreLeft:900,livesLeft:500,scoreTop:50},t=new PIXI.Container,o=$.extend({},n.textStyle,{fill:n.livesFill});i=new PIXI.Text("",o),i.position.x=n.livesLeft,i.position.y=n.scoreTop;var e=$.extend({},n.textStyle,{fill:n.scoreFill});return r=new PIXI.Text("",e),r.position.x=n.scoreLeft,r.position.y=n.scoreTop,t.addChild(i),t.addChild(r),t}function o(n){r.text=n}function e(n){i.text=n}var i,r;t.prototype.setScore=function(n){o.call(this,n)},t.prototype.setLives=function(n){e.call(this,n)},t.prototype.createDialog=function(){return n.call(this)}}n.Graphics.Widgets.ScoreBoardDialog=t}(FunnyRain),function(n){function t(o){function e(){p=y.getView(),d=new n.Graphics.Widgets.ScoreBoardDialog,p.createWidget(d.createDialog())}function i(n){n!==g&&(g=n,g&&l())}function r(n){s=n,d.setLives(n)}function a(n){f=n,d.setScore(n)}function c(n){r(s+n)}function u(n){a(f+n)}function l(){a(0),r(3)}var s,f,p,y=o,d=null,g=!1;t.prototype.load=function(){e.call(this)},t.prototype.enable=function(n){i.call(this,n)},t.prototype.changeScore=function(n){u.call(this,n)},t.prototype.changeLives=function(n){c.call(this,n)}}n.Plugins.ScoreBoard.ScoreManager=t}(FunnyRain),function(n){function t(o){function e(t){i=new n.Plugins.ScoreBoard.ScoreManager(t.getGame())}n.Plugins.BasePlugin.call(this,"ScoreBoard",o);var i=null;e(this),t.prototype.load=function(){i.load()},t.prototype.getScoreManager=function(){return i},t.prototype.enable=function(n){return i.enable(n)}}n.Plugins.ScoreBoard.ScoreBoardPlugin=Boplex.inherit(t,n.Plugins.BasePlugin)}(FunnyRain);