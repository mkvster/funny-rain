"use strict";var FunnyRain={};!function(n){Boplex.defineConstProp(n,"Version","0.0.1"),n.Physics={},n.Graphics={},n.Graphics.Widgets={},n.Plugins={},n.Plugins.Blocks={},n.Plugins.FallingThings={},n.Plugins.ScoreBoard={},n.Plugins.Rocket={}}(FunnyRain),function(n){function t(o){function e(t){h=new n.Physics.RainWorld({onDestroyBody:p}),g=new n.Graphics.View,x=new n.Plugins.PluginManager(t),$(y).length>0&&($(y).append(g.getView()),d=new n.Graphics.AnimFrame(s,f),$(document).on("dblclick touchstart",r))}function i(n){if(!("clientX"in n)&&n.originalEvent.changedTouches)for(var t=n.originalEvent.changedTouches,o=0;o<t.length;o++){n.clientX=Math.round(t[o].pageX),n.clientY=Math.round(t[o].pageY);break}}function r(n){if(!B)return void l();i(n);var t=g.getScale()||1,o=n.clientX/t,e=n.clientY/t,r=c(o,e);(!r||r&&v)&&u(),r&&r.onDblClick&&r.onDblClick(n)}function c(n,t){var o=h,e=o.findBody(n,t);return e?e.block:null}function a(){B=!1,v=!1,x.enable(!1)}function l(){B=!0,v=!1,h.setIsPaused(!1),x.enable(!0)}function u(){v=!v,h.setIsPaused(!h.getIsPaused())}function s(n,t,o){g.setScale(n,t,o)}function f(){h.step(),x.step(),g.step()}function p(n,t){var o=t.block;o&&o.onDestroy&&o.onDestroy()}var y=o,d=null,g=null,h=null,B=!1,v=!1,x=null;e(this),t.prototype.getPluginManager=function(){return x},t.prototype.getView=function(){return g},t.prototype.getRainWorld=function(){return h},t.prototype.finish=function(){return a.call(this)},function(){x.load(),l()}()}n.Game=t}(FunnyRain),function(n){function t(n){function o(){var n=new Box2D.Common.Math.b2Vec2(x.gravity.x,x.gravity.y);B=new Box2D.Dynamics.b2World(n,!0)}function e(n){return n/x.RATIO}function i(n){var t={width:50,height:50,x:0,y:-60,restitution:.3,friction:10,density:1},o=$.extend({},t,n),i=new Box2D.Dynamics.b2BodyDef;i.type=Box2D.Dynamics.b2Body.b2_dynamicBody,i.position.Set(e(o.x),e(o.y));var r=B.CreateBody(i),c=new Box2D.Dynamics.b2FixtureDef;return c.shape=new Box2D.Collision.Shapes.b2PolygonShape,c.shape.SetAsBox(e(o.width),e(o.height)),c.density=o.density,c.restitution=o.restitution,c.friction=o.friction,r.CreateFixture(c),r}function r(n,t,o,e){var i=new Box2D.Dynamics.b2BodyDef;i.position.Set(n,t);var r=B.CreateBody(i),c=new Box2D.Dynamics.b2FixtureDef;return c.shape=new Box2D.Collision.Shapes.b2PolygonShape,c.shape.SetAsBox(o,e),c.density=1,r.CreateFixture(c),r}function c(){var n={timeStep:1/60,velocityIterations:8,positionIterations:4},t=n.timeStep;b&&(t=0),B.Step(t,n.velocityIterations,n.positionIterations),B.DrawDebugData(),B.ClearForces(),s()}function a(n){b=n}function l(){return b}function u(){return x.RATIO}function s(){P.forEach(function(n){B.DestroyBody(n)}),P=[]}function f(n){new Boplex.Event(null,m).raise(n),P.push(n)}function p(n,t){var o=new Box2D.Collision.b2AABB;return o.lowerBound.Set(n.x-t,n.y-t),o.upperBound.Set(n.x+t,n.y+t),o}function y(n,t){var o={size:x.bodySize},e=n.GetPosition();return t.x>=e.x&&t.x<=e.x+o.size&&t.y>=e.y&&t.y<=e.y+o.size}function d(n,t){var o,i={radius:x.bodySize},r=new Box2D.Common.Math.b2Vec2(e(n),e(t)),c=p(r,e(i.radius));return B.QueryAABB(function(n){var t=n.GetBody();return t.GetType()===Box2D.Dynamics.b2Body.b2_dynamicBody&&y(t,r)?(o=t,!1):!0},c),o}function g(n,t){function o(i){for(var r=i.GetContactList();r;){var c=r.other;!c.group&&t(c,n)&&(e.push(c),c.group=e,o(c)),r=r.next}}var e=[n];return n.group=e,o(n),e}function h(n,t){var o=1,i={size:x.bodySize,power:t||1.5},r=p(n.GetWorldCenter(),e(i.power*i.size));return B.QueryAABB(function(t){var e=t.GetBody();if(n!==e&&e.GetType()===Box2D.Dynamics.b2Body.b2_dynamicBody){e.GetPosition();o+=1,f(e)}return!0},r),f(n),o}var B,v=(new Boplex.Logger("FunnyRain.Physics.BaseWorld"),{RATIO:50,gravity:{x:0,y:0},onDestroyBody:null}),x=$.extend({},v,n),P=[],m=x.onDestroyBody,b=!1;o(),t.prototype.b2m=function(n){return e.call(this,n)},t.prototype.getBox2dWorld=function(){return B},t.prototype.setIsPaused=function(n){a.call(this,n)},t.prototype.getIsPaused=function(){return l.call(this)},t.prototype.step=function(){c.call(this)},t.prototype.getScale=function(){return u.call(this)},t.prototype.createWall=function(n,t,o,e){return r.call(this,n,t,o,e)},t.prototype.createDynamicBody=function(n){return i.call(this,n)},t.prototype.findBody=function(n,t){return d.call(this,n,t)},t.prototype.destroyBody=function(n){return f.call(this,n)},t.prototype.getMatchGroup=function(n,t){return g.call(this,n,t)},t.prototype.explodeBody=function(n,t){return h.call(this,n,t)}}n.Physics.BaseWorld=t}(FunnyRain),function(n){function t(o){function e(n){i(n)}function i(n){var t={wallSize:10,bottomPadding:100,leftPadding:0,rightPadding:100},o=n.b2m,e=n.createWall;e(0,o(a.canvasSize.y-t.bottomPadding),o(a.canvasSize.x),o(t.wallSize)),e(o(t.leftPadding),0,o(t.wallSize),o(a.canvasSize.y)),e(o(a.canvasSize.x-t.rightPadding),0,o(t.wallSize),o(a.canvasSize.y))}function r(n,t){var o={width:a.bodySize,height:a.bodySize,x:t||0,y:-60,restitution:.3,friction:10,density:1},e=n.createDynamicBody(o);return e}var c={canvasSize:{x:1600,y:1200},gravity:{x:0,y:9.8},bodySize:50},a=$.extend({},c,o);n.Physics.BaseWorld.call(this,a),e(this),t.prototype.createBody=function(n){return r.call(this,this,n)}}n.Physics.RainWorld=Boplex.inherit(t,n.Physics.BaseWorld)}(FunnyRain),function(n){function t(n,t,o){function e(){var n=$(window).innerWidth(),t=$(window).innerHeight();r(n,t)}function i(){requestAnimationFrame(i),a()}function r(n,t){var o=1,e=u.canvasSize,i=n/e.x,r=t/e.y;o=i>1||r>1?1:r>i?i:r;var a=o*e.x,l=o*e.y;c(o,a,l)}var c=n,a=t,l=(new Boplex.Logger("FunnyRain.AnimFrame"),{canvasSize:{x:1600,y:1200},dpr:window.devicePixelRatio}),u=$.extend({},l,o);!function(){i(),$(window).on("resize deviceOrientation",e),$(window).trigger("resize")}(),window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(n){window.setTimeout(n,1e3/60)}}()}n.Graphics.AnimFrame=t}(FunnyRain),function(n){function t(n){function o(n){var t=v.assetsDir+n+".png";return t}function e(){g=PIXI.autoDetectRenderer(v.canvasSize.x,v.canvasSize.y,{backgroundColor:v.backgroundColor}),h=c(v.backgroundImage),i()}function i(){PIXI.loader.add("explosion","assets/explosion.json").load()}function r(n){var t=o(n),e=new PIXI.Sprite.fromImage(t);return e}function c(n){var t=r(n),o=new PIXI.Container;return o.addChild(t),o.sprite=t,o}function a(n){var t=c(n);return h.addChild(t),t}function l(n){if(n){var t=n.parent;t&&t.removeChild(n)}}function u(){return g.view}function s(n,t,o){h.scale.x=h.scale.y=n,g.resize(t,o)}function f(){return h.scale.x}function p(){g.render(h)}function y(n){return h.addChild(n),n}function d(n){l(n)}var g,h,B=(new Boplex.Logger("FunnyRain.Graphics.View"),{canvasSize:{x:1600,y:1200},backgroundColor:1087931,assetsDir:"assets/",backgroundImage:"background"}),v=$.extend({},B,n);e(),t.prototype.step=function(){p.call(this)},t.prototype.setScale=function(n,t,o){s.call(this,n,t,o)},t.prototype.getScale=function(){return f.call(this)},t.prototype.getView=function(){return u.call(this)},t.prototype.createActor=function(n){return a.call(this,n)},t.prototype.destroyActor=function(n){return l.call(this,n)},t.prototype.createWidget=function(n){return y.call(this,n)},t.prototype.destroyWidget=function(n){return d.call(this,n)}}n.Graphics.View=t}(FunnyRain),function(n){function t(o){function e(){var n=i();f=f.concat(n)}function i(){var t=[new n.Plugins.Rocket.RocketPlugin(s),new n.Plugins.ScoreBoard.ScoreBoardPlugin(s),new n.Plugins.Blocks.BlocksPlugin(s),new n.Plugins.FallingThings.FallingThingsPlugin(s)];return t}function r(n,t){for(var o=f.length,e=n?0:o-1,i=null;!i&&e>-1&&o>e;)i=t(f[e]),e=n?e+1:e-1;return i}function c(){r(!0,function(n){n.load&&n.load()})}function a(){r(!0,function(n){n.step&&n.step()})}function l(n){r(n,function(t){t.enable&&t.enable(n)})}function u(n){var t=r(!1,function(t){return n===t.getPluginId()?t:void 0});return t}var s=o,f=[];e(),t.prototype.load=function(){c.call(this)},t.prototype.step=function(){a.call(this)},t.prototype.enable=function(n){l.call(this,n)},t.prototype.findPlugin=function(n){return u.call(this,n)}}n.Plugins.PluginManager=t}(FunnyRain),function(n){function t(n,o){function e(n){return n._id}function i(){return r}this._id=n;var r=o;t.prototype.getPluginId=function(){return e.call(this,this)},t.prototype.getGame=function(){return i.call(this)}}n.Plugins.BasePlugin=t}(FunnyRain),function(n){function t(o){function e(t){i=new n.Plugins.Blocks.BlocksFactory(t.getGame())}n.Plugins.BasePlugin.call(this,"Blocks",o);var i=null;e(this),t.prototype.getBlocksFactory=function(){return i},t.prototype.enable=function(n){i.enable(n)}}n.Plugins.Blocks.BlocksPlugin=Boplex.inherit(t,n.Plugins.BasePlugin)}(FunnyRain),function(n){function t(o){function e(){p=0}function i(n){for(var t=0;t<d.length;t++){var o=d[t];if(o.blockCategory===n)return o}return null}function r(n,t){var o=++p,e=new n.blockClass(o,y,n.blockTypes[t],n.blockCategory,function(n,t){l(t)});return g.push(e),e}function c(n){var t=Boplex.random(0,n.blockTypes.length-1);return r(n,t)}function a(n){var t=i(n);if(!t)throw new RangeError(n+" - unknown block category");return c(t)}function l(n){for(var t=0;t<g.length;t++)if(n===g[t]){g.splice(t,1);break}}function u(n,t){t!==f&&(f=t,f&&s(n))}function s(n){for(;g.length;)g[0].destroy()}var f,p,y=o,d=[{blockCategory:"fruit",blockClass:n.Plugins.Blocks.FruitBlock,blockTypes:["apple","peach","orange"]},{blockCategory:"bomb",blockClass:n.Plugins.Blocks.BombBlock,blockTypes:["bomb"]}],g=[];e(),t.prototype.createBlockByCategory=function(n){return a.call(this,n)},t.prototype.forEach=function(n){g.forEach(n)},t.prototype.destroyBlock=function(n){l.call(this,n)},t.prototype.enable=function(n){u.call(this,this,n)}}n.Plugins.Blocks.BlocksFactory=t}(FunnyRain),function(n){function t(n,o,e,i,r){function c(n,t,o,e,i){w=t,k=o,S=e,n.body=k.createBody(i),n.body.block=n,n.actor=S.createActor(n.type),n.adjust(),n.scheduleNextAction()}function a(n){var t=.2;n.actor.scale.x=n.actor.scale.y=t}function l(n,t,o){n.timeout=setTimeout(function(){w.getIsEnabled()&&(n.timeout=null,o(n))},t)}function u(n,t,o,e){var i=Boplex.random(t,o);l(n,i,e)}function s(n){var t={lifeTimeMin:1e4,lifeTimeMax:5e4};u(n,t.lifeTimeMin,t.lifeTimeMax,function(){return k.getIsPaused()?void s(n):void k.destroyBody(n.body)})}function f(n){s(n)}function p(n){y(n),d(n),new Boplex.Event(n,F).raise(n)}function y(n){var t=n.timeout;t&&clearTimeout(t)}function d(n){n.actor&&(S.destroyActor(n.actor),n.actor=null)}function g(n){if(n.body&&n.actor){var t=k.getScale(),o=n.body.GetPosition();n.actor.position.x=o.x*t,n.actor.position.y=o.y*t}}function h(n,t){B(n,t)}function B(n,t){n.isResolved;n.isResolved=!0;var o=v(n,t);o.forEach(function(n){k.destroyBody(n)});var e=b.getPluginManager().findPlugin("ScoreBoard");if(e.getScoreManager().changeScore(o.length),o.length>2){var i=b.getPluginManager().findPlugin("Rocket");if(i){var r=S.getScale()||1,c=t.clientX/r;i.launch(c)}}}function v(n,t){return k.getMatchGroup(n.body,function(t){return t.block?n.compareGroup(t.block):void 0})}function x(n,t){return n.type===t.type}function P(){return b}function m(n){k.destroyBody(n.body)}var b=o;this.type=e;this.body=null,this.actor=null;var w,k,S;this.timeout;var F=r;t.prototype.getGame=function(){return P.call(this)},t.prototype.getPhysics=function(){return k},t.prototype.getGraphics=function(){return S},t.prototype.install=function(n,t,o,e){c.call(this,this,n,t,o,e)},t.prototype.adjust=function(){a.call(this,this)},t.prototype.destroy=function(){m.call(this,this)},t.prototype.adjust=function(){a.call(this,this)},t.prototype.scheduleDestroy=function(){s.call(this,this)},t.prototype.scheduleNextAction=function(){f.call(this,this)},t.prototype.onDestroy=function(){p.call(this,this)},t.prototype.step=function(){g.call(this,this)},t.prototype.onDblClick=function(n){h.call(this,this,n)},t.prototype.compareGroup=function(n){return x.call(this,this,n)},t.prototype.scheduleRandomVisit=function(n,t,o){return u.call(this,this,n,t,o)}}n.Plugins.Blocks.BaseBlock=t}(FunnyRain),function(n){function t(t,o,e,i,r){function c(n){n.scale=.2}n.Plugins.Blocks.BaseBlock.call(this,t,o,e,i,r),c(this)}n.Plugins.Blocks.FruitBlock=Boplex.inherit(t,n.Plugins.Blocks.BaseBlock)}(FunnyRain),function(n){function t(o,e,i,r,c){function a(n){n.actor.scale.x=n.actor.scale.y=.2,n.actor.sprite.rotation=-.05,TweenMax.to(n.actor.sprite,.1,{rotation:.05,yoyo:!0,repeat:-1}),TweenMax.to(n.actor.scale,.15,{x:.18,yoyo:!0,repeat:-1}),TweenMax.to(n.actor.scale,.15,{y:.18,yoyo:!0,repeat:-1})}function l(n){var t={lifeTimeMin:4e3,lifeTimeMax:15e3},o=n.getGame().getPluginManager().findPlugin("ScoreBoard"),e=n.getPhysics();n.scheduleRandomVisit(t.lifeTimeMin,t.lifeTimeMax,function(){if(e.getIsPaused())return void l(n);var t=n.actor.position;u(n,t),e.explodeBody(n.body),o.getScoreManager().changeLives(-1)})}function u(n,t){var o=s.createExplosion(t),e=n.getGraphics();e.createWidget(o),setTimeout(function(){e.destroyWidget(o)},500)}n.Plugins.Blocks.BaseBlock.call(this,o,e,i,r,c);var s=new n.Graphics.Widgets.ExplosionClip;t.prototype.adjust=function(){a.call(this,this)},t.prototype.scheduleNextAction=function(){l.call(this,this)}}n.Plugins.Blocks.BombBlock=Boplex.inherit(t,n.Plugins.Blocks.BaseBlock)}(FunnyRain),function(n){function t(o){function e(t){i=new n.Plugins.FallingThings.FallManager(t.getGame())}n.Plugins.BasePlugin.call(this,"FallingThings",o);var i=null;e(this),t.prototype.load=function(){i.load()},t.prototype.getFallManager=function(){return i},t.prototype.enable=function(n){i.enable(n)},t.prototype.step=function(){i.step()}}n.Plugins.FallingThings.FallingThingsPlugin=Boplex.inherit(t,n.Plugins.BasePlugin)}(FunnyRain),function(n){function t(n){function o(){}function e(){f=y.getRainWorld(),p=y.getView();var n=y.getPluginManager().findPlugin("Blocks");s=n.getBlocksFactory()}function i(){var n={bomb:25,max:100},t=Boplex.random(0,n.max);return t<n.bomb?"bomb":"fruit"}function r(n,t){var o=i(),e=s.createBlockByCategory(o);e.install(n,f,p,t)}function c(n){var t={fallWidth:1200,leftPadding:50,nextTimeMin:500,nextTimeMax:1e3},o=t.leftPadding+Boplex.random(0,t.fallWidth),e=Boplex.random(t.nextTimeMin,t.nextTimeMax);u&&(f.getIsPaused()||r(n,o),setTimeout(function(){c(n)},e))}function a(n,t){t!==u&&(u=t,u&&c(n))}function l(){s&&s.forEach(function(n){n.step()})}var u,s,f,p,y=n;o(),t.prototype.load=function(n){e.call(this)},t.prototype.enable=function(n){a.call(this,this,n)},t.prototype.getIsEnabled=function(){return u},t.prototype.step=function(){l.call(this)}}n.Plugins.FallingThings.FallManager=t}(FunnyRain),function(n){function t(){function n(){var n={textStyle:{font:"240px Courier Bold",strokeThickness:8,stroke:"white"},livesFill:"red",scoreFill:"green",scoreLeft:900,livesLeft:500,scoreTop:50},t=new PIXI.Container,o=$.extend({},n.textStyle,{fill:n.livesFill});i=new PIXI.Text("",o),i.position.x=n.livesLeft,i.position.y=n.scoreTop;var e=$.extend({},n.textStyle,{fill:n.scoreFill});return r=new PIXI.Text("",e),r.position.x=n.scoreLeft,r.position.y=n.scoreTop,t.addChild(i),t.addChild(r),t}function o(n){r.text=n}function e(n){i.text=n}var i,r;t.prototype.setScore=function(n){o.call(this,n)},t.prototype.setLives=function(n){e.call(this,n)},t.prototype.createDialog=function(){return n.call(this)}}n.Graphics.Widgets.ScoreBoardDialog=t}(FunnyRain),function(n){function t(o){function e(){p=y.getView(),d=new n.Graphics.Widgets.ScoreBoardDialog,p.createWidget(d.createDialog())}function i(n){n!==g&&(g=n,g&&u())}function r(n){0>n&&(n=0),s=n,d.setLives(n),0===s&&y.finish()}function c(n){f=n,d.setScore(n)}function a(n){r(s+n)}function l(n){c(f+n)}function u(){c(0),r(3)}var s,f,p,y=o,d=null,g=!1;t.prototype.load=function(){e.call(this)},t.prototype.enable=function(n){i.call(this,n)},t.prototype.changeScore=function(n){l.call(this,n)},t.prototype.changeLives=function(n){a.call(this,n)}}n.Plugins.ScoreBoard.ScoreManager=t}(FunnyRain),function(n){function t(o){function e(t){i=new n.Plugins.ScoreBoard.ScoreManager(t.getGame())}n.Plugins.BasePlugin.call(this,"ScoreBoard",o);var i=null;e(this),t.prototype.load=function(){i.load()},t.prototype.getScoreManager=function(){return i},t.prototype.enable=function(n){return i.enable(n)}}n.Plugins.ScoreBoard.ScoreBoardPlugin=Boplex.inherit(t,n.Plugins.BasePlugin)}(FunnyRain),function(n){function t(o){function e(n){u=n.getGame().getView()}function i(n){l=u.createActor("rocket"),l.scale.x=l.scale.y=1,l.position.y=p,l.position.x=n-f/2}function r(){u.destroyActor(l),l=null,y=0}function c(n){l||i(n)}function a(){l&&(y+=d,l.position.y-=y,l.position.y<-s&&r())}n.Plugins.BasePlugin.call(this,"Rocket",o);var l,u=null,s=600,f=340,p=1200,y=0,d=1;t.prototype.load=function(n){e.call(this,this)},t.prototype.launch=function(n){c.call(this,n)},t.prototype.step=function(){a.call(this)}}n.Plugins.Rocket.RocketPlugin=Boplex.inherit(t,n.Plugins.BasePlugin)}(FunnyRain),function(n){function t(){function n(){o()}function o(){for(var n=0;i>n;n++){var t=PIXI.Texture.fromFrame("Explosion_Sequence_A "+(n+1)+".png");r.push(t)}}function e(n){var t=new PIXI.Container,o=new PIXI.extras.MovieClip(r);return o.position.x=n.x,o.position.y=n.y,o.anchor.x=.5,o.anchor.y=.5,o.rotation=Math.random()*Math.PI,o.scale.set(.75+.5*Math.random()),o.gotoAndPlay(27*Math.random()),t.addChild(o),t}var i=26,r=[];n(),t.prototype.createExplosion=function(n){return e.call(this,n)}}n.Graphics.Widgets.ExplosionClip=t}(FunnyRain);