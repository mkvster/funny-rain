"use strict";var FunnyRain={};!function(n){Boplex.defineConstProp(n,"Version","0.0.1"),n.Physics={},n.Graphics={},n.Plugins={},n.Plugins.Blocks={},n.Plugins.FallingThings={}}(FunnyRain),function(n){function t(o){function i(t){d=new n.Physics.RainWorld({onDestroyBody:s}),p=new n.Graphics.View,B=new n.Plugins.PluginManager(t),$(f).length>0&&($(f).append(p.getView()),y=new n.Graphics.AnimFrame(u,l),$(document).on("dblclick touchstart",e))}function e(n){if(!g)return void a();var t=r(n.clientX,n.clientY);(!t||t&&h)&&c(),t&&t.onDblClick&&t.onDblClick(n)}function r(n,t){var o=d,i=o.findBody(n,t);return i?i.block:null}function a(){g=!0,h=!1,d.setIsPaused(!1),B.enable(!0)}function c(){h=!h,d.setIsPaused(!d.getIsPaused())}function u(n,t,o){p.setScale(n,t,o)}function l(){d.step(),B.step(),p.step()}function s(n,t){var o=t.block;o&&o.onDestroy&&o.onDestroy()}var f=o,y=null,p=null,d=null,g=!1,h=!1,B=null;i(this),t.prototype.getPluginManager=function(){return B},t.prototype.getView=function(){return p},t.prototype.getRainWorld=function(){return d},function(){B.load(),a()}()}n.Game=t}(FunnyRain),function(n){function t(n){function o(){var n=new Box2D.Common.Math.b2Vec2(v.gravity.x,v.gravity.y);h=new Box2D.Dynamics.b2World(n,!0)}function i(n){return n/v.RATIO}function e(n){var t={width:50,height:50,x:0,y:-60,restitution:.3,friction:10,density:1},o=$.extend({},t,n),e=new Box2D.Dynamics.b2BodyDef;e.type=Box2D.Dynamics.b2Body.b2_dynamicBody,e.position.Set(i(o.x),i(o.y));var r=h.CreateBody(e),a=new Box2D.Dynamics.b2FixtureDef;return a.shape=new Box2D.Collision.Shapes.b2PolygonShape,a.shape.SetAsBox(i(o.width),i(o.height)),a.density=o.density,a.restitution=o.restitution,a.friction=o.friction,r.CreateFixture(a),r}function r(n,t,o,i){var e=new Box2D.Dynamics.b2BodyDef;e.position.Set(n,t);var r=h.CreateBody(e),a=new Box2D.Dynamics.b2FixtureDef;return a.shape=new Box2D.Collision.Shapes.b2PolygonShape,a.shape.SetAsBox(o,i),a.density=1,r.CreateFixture(a),r}function a(){var n={timeStep:1/60,velocityIterations:8,positionIterations:4},t=n.timeStep;b&&(t=0),h.Step(t,n.velocityIterations,n.positionIterations),h.DrawDebugData(),h.ClearForces(),s()}function c(n){b=n}function u(){return b}function l(){return v.RATIO}function s(){m.forEach(function(n){h.DestroyBody(n)}),m=[]}function f(n){new Boplex.Event(null,x).raise(n),m.push(n)}function y(n,t){var o=new Box2D.Collision.b2AABB;return o.lowerBound.Set(n.x-t,n.y-t),o.upperBound.Set(n.x+t,n.y+t),o}function p(n,t){var o={size:v.bodySize},i=n.GetPosition();return t.x>=i.x&&t.x<=i.x+o.size&&t.y>=i.y&&t.y<=i.y+o.size}function d(n,t){var o,e={radius:v.bodySize},r=new Box2D.Common.Math.b2Vec2(i(n),i(t)),a=y(r,i(e.radius));return h.QueryAABB(function(n){var t=n.GetBody();return t.GetType()===Box2D.Dynamics.b2Body.b2_dynamicBody&&p(t,r)?(o=t,!1):!0},a),o}function g(n,t){function o(e){for(var r=e.GetContactList();r;){var a=r.other;!a.group&&t(a,n)&&(i.push(a),a.group=i,o(a)),r=r.next}}var i=[n];return n.group=i,o(n),i}var h,B=(new Boplex.Logger("FunnyRain.Physics.BaseWorld"),{RATIO:50,gravity:{x:0,y:0},onDestroyBody:null}),v=$.extend({},B,n),m=[],x=v.onDestroyBody,b=!1;o(),t.prototype.b2m=function(n){return i.call(this,n)},t.prototype.getBox2dWorld=function(){return h},t.prototype.setIsPaused=function(n){c.call(this,n)},t.prototype.getIsPaused=function(){return u.call(this)},t.prototype.step=function(){a.call(this)},t.prototype.getScale=function(){return l.call(this)},t.prototype.createWall=function(n,t,o,i){return r.call(this,n,t,o,i)},t.prototype.createDynamicBody=function(n){return e.call(this,n)},t.prototype.findBody=function(n,t){return d.call(this,n,t)},t.prototype.destroyBody=function(n){return f.call(this,n)},t.prototype.getMatchGroup=function(n,t){return g.call(this,n,t)}}n.Physics.BaseWorld=t}(FunnyRain),function(n){function t(o){function i(n){e(n)}function e(n){var t={wallSize:10,bottomPadding:100,leftPadding:0,rightPadding:100},o=n.b2m,i=n.createWall;i(0,o(c.canvasSize.y-t.bottomPadding),o(c.canvasSize.x),o(t.wallSize)),i(o(t.leftPadding),0,o(t.wallSize),o(c.canvasSize.y)),i(o(c.canvasSize.x-t.rightPadding),0,o(t.wallSize),o(c.canvasSize.y))}function r(n,t){var o={width:c.bodySize,height:c.bodySize,x:t||0,y:-60,restitution:.3,friction:10,density:1},i=n.createDynamicBody(o);return i}var a={canvasSize:{x:1600,y:1200},gravity:{x:0,y:9.8},bodySize:50},c=$.extend({},a,o);n.Physics.BaseWorld.call(this,c),i(this),t.prototype.createBody=function(n){return r.call(this,this,n)}}n.Physics.RainWorld=Boplex.inherit(t,n.Physics.BaseWorld)}(FunnyRain),function(n){function t(n,t,o){function i(){var n=$(window).innerWidth(),t=$(window).innerHeight();r(n,t)}function e(){requestAnimationFrame(e),c()}function r(n,t){var o=1,i=l.canvasSize,e=n/i.x,r=t/i.y;o=e>1||r>1?1:r>e?e:r;var c=o*i.x,u=o*i.y;a(o,c,u)}var a=n,c=t,u=(new Boplex.Logger("FunnyRain.AnimFrame"),{canvasSize:{x:1600,y:1200},dpr:window.devicePixelRatio}),l=$.extend({},u,o);!function(){e(),$(window).on("resize deviceOrientation",i),$(window).trigger("resize")}(),window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(n){window.setTimeout(n,1e3/60)}}()}n.Graphics.AnimFrame=t}(FunnyRain),function(n){function t(n){function o(n){var t=g.assetsDir+n+".png";return t}function i(){y=PIXI.autoDetectRenderer(g.canvasSize.x,g.canvasSize.y,{backgroundColor:g.backgroundColor}),p=a(g.backgroundImage),e()}function e(){}function r(n){var t=o(n),i=new PIXI.Sprite.fromImage(t);return i}function a(n){var t=r(n),o=new PIXI.Container;return o.addChild(t),o.sprite=t,o}function c(n){var t=a(n);return p.addChild(t),t}function u(n){if(n){var t=n.parent;t&&t.removeChild(n)}}function l(){return y.view}function s(n,t,o){p.scale.x=p.scale.y=n,y.resize(t,o)}function f(){y.render(p)}var y,p,d=(new Boplex.Logger("FunnyRain.Graphics.View"),{canvasSize:{x:1600,y:1200},backgroundColor:1087931,assetsDir:"assets/",backgroundImage:"background"}),g=$.extend({},d,n);i(),t.prototype.step=function(){f.call(this)},t.prototype.setScale=function(n,t,o){s.call(this,n,t,o)},t.prototype.getView=function(){return l.call(this)},t.prototype.createActor=function(n){return c.call(this,n)},t.prototype.destroyActor=function(n){return u.call(this,n)}}n.Graphics.View=t}(FunnyRain),function(n){function t(o){function i(){var n=e();f=f.concat(n)}function e(){var t=[new n.Plugins.Blocks.BlocksPlugin(s),new n.Plugins.FallingThings.FallingThingsPlugin(s)];return t}function r(n,t){for(var o=f.length,i=n?0:o-1,e=null;!e&&i>-1&&o>i;)e=t(f[i]),i=n?i+1:i-1;return e}function a(){r(!0,function(n){n.load&&n.load()})}function c(){r(!0,function(n){n.step&&n.step()})}function u(n){r(n,function(t){t.enable&&t.enable(n)})}function l(n){var t=r(!1,function(t){return n===t.getPluginId()?t:void 0});return t}var s=o,f=[];i(),t.prototype.load=function(){a.call(this)},t.prototype.step=function(){c.call(this)},t.prototype.enable=function(n){u.call(this,n)},t.prototype.findPlugin=function(n){return l.call(this,n)}}n.Plugins.PluginManager=t}(FunnyRain),function(n){function t(n,o){function i(n){return n._id}function e(){return r}this._id=n;var r=o;t.prototype.getPluginId=function(){return i.call(this,this)},t.prototype.getGame=function(){return e.call(this)}}n.Plugins.BasePlugin=t}(FunnyRain),function(n){function t(o){function i(t){e=new n.Plugins.Blocks.BlocksFactory}n.Plugins.BasePlugin.call(this,"Blocks",o);var e=null;i(this),t.prototype.getBlocksFactory=function(){return e}}n.Plugins.Blocks.BlocksPlugin=Boplex.inherit(t,n.Plugins.BasePlugin)}(FunnyRain),function(n){function t(o){function i(){u=0}function e(n){for(var t=0;t<l.length;t++){var o=l[t];if(o.blockCategory===n)return o}return null}function r(n){var t=Boplex.random(0,n.blockTypes.length-1),o=++u,i=new n.blockClass(o,n.blockTypes[t],n.blockCategory);return f.push(i),i}function a(n){var t=e(n);if(!t)throw new RangeError(n+" - unknown block category");return r(t)}function c(n){for(var t=0;t<f.length;t++)if(n===f[t]){f.splice(t,1);break}}var u,l=[{blockCategory:"fruit",blockClass:n.Plugins.Blocks.FruitBlock,blockTypes:["apple","peach","orange"]},{blockCategory:"bomb",blockClass:n.Plugins.Blocks.BombBlock,blockTypes:["bomb"]}],s={},f=($.extend({},s,o),[]);i(),t.prototype.createBlockByCategory=function(n){return a.call(this,n)},t.prototype.forEach=function(n){f.forEach(n)},t.prototype.destroyBlock=function(n){c.call(this,n)}}n.Plugins.Blocks.BlocksFactory=t}(FunnyRain),function(n){function t(n,o,i){function e(n,t,o,i,e,r){g=t,h=o,B=i,n.body=h.createBody(e),n.body.block=n,n.actor=B.createActor(n.type),n.adjust(),n.scheduleDestroy()}function r(n){var t=.2;n.actor.scale.x=n.actor.scale.y=t}function a(n){var t={lifeTimeMin:1e4,lifeTimeMax:5e4},o=Boplex.random(t.lifeTimeMin,t.lifeTimeMax);n.timeout=setTimeout(function(){if(g.getIsEnabled()){if(n.timeout=null,h.getIsPaused())return void a(n);h.destroyBody(n.body)}},o)}function c(n){u(n),l(n),new Boplex.Event(n,v).raise(n)}function u(n){var t=n.timeout;t&&clearTimeout(t)}function l(n){n.actor&&(B.destroyActor(n.actor),n.actor=null)}function s(n){if(n.body&&n.actor){var t=h.getScale(),o=n.body.GetPosition();n.actor.position.x=o.x*t,n.actor.position.y=o.y*t}}function f(n,t){y(n,t)}function y(n,t){n.isResolved;n.isResolved=!0;var o=p(n,t);o.forEach(function(n){h.destroyBody(n)})}function p(n,t){return h.getMatchGroup(n.body,function(t){return t.block?n.compareGroup(t.block):void 0})}function d(n,t){return n.type===t.type}this.type=o;this.body=null,this.actor=null;var g,h,B;this.timeout;var v;t.prototype.install=function(n,t,o,i){e.call(this,this,n,t,o,i)},t.prototype.adjust=function(){r.call(this,this)},t.prototype.adjust=function(){r.call(this,this)},t.prototype.scheduleDestroy=function(){a.call(this,this)},t.prototype.onDestroy=function(){c.call(this,this)},t.prototype.step=function(){s.call(this,this)},t.prototype.onDblClick=function(n){f.call(this,this,n)},t.prototype.compareGroup=function(n){return d.call(this,this,n)}}n.Plugins.Blocks.BaseBlock=t}(FunnyRain),function(n){function t(t,o,i){function e(n){n.scale=.2}n.Plugins.Blocks.BaseBlock.call(this,t,o,i,_settings),e(this)}n.Plugins.Blocks.FruitBlock=Boplex.inherit(t,n.Plugins.Blocks.BaseBlock)}(FunnyRain),function(n){function t(o,i,e){function r(n){n.actor.scale.x=n.actor.scale.y=.2,n.actor.sprite.rotation=-.05,TweenMax.to(n.actor.sprite,.1,{rotation:.05,yoyo:!0,repeat:-1}),TweenMax.to(n.actor.scale,.15,{x:.18,yoyo:!0,repeat:-1}),TweenMax.to(n.actor.scale,.15,{y:.18,yoyo:!0,repeat:-1})}n.Plugins.Blocks.BaseBlock.call(this,o,i,e),t.prototype.adjust=function(){r.call(this,this)}}n.Plugins.Blocks.BombBlock=Boplex.inherit(t,n.Plugins.Blocks.BaseBlock)}(FunnyRain),function(n){function t(o){function i(t){e=new n.Plugins.FallingThings.FallManager(t.getGame())}n.Plugins.BasePlugin.call(this,"FallingThings",o);var e=null;i(this),t.prototype.load=function(){e.load()},t.prototype.getFallManager=function(){return e},t.prototype.enable=function(n){e.enable(n)},t.prototype.step=function(){e.step()}}n.Plugins.FallingThings.FallingThingsPlugin=Boplex.inherit(t,n.Plugins.BasePlugin)}(FunnyRain),function(n){function t(n){function o(){}function i(){f=p.getRainWorld(),y=p.getView();var n=p.getPluginManager().findPlugin("Blocks");s=n.getBlocksFactory()}function e(){var n={bomb:25,max:100},t=Boplex.random(0,n.max);return t<n.bomb?"bomb":"fruit"}function r(n,t){var o=e(),i=s.createBlockByCategory(o);i.install(n,f,y,t,function(n,t){s.destroyBlock(t)})}function a(n){var t={fallWidth:1200,leftPadding:50,nextTimeMin:500,nextTimeMax:1e3},o=t.leftPadding+Boplex.random(0,t.fallWidth),i=Boplex.random(t.nextTimeMin,t.nextTimeMax);l&&(f.getIsPaused()||r(n,o),setTimeout(function(){a(n)},i))}function c(n,t){t!==l&&(l=t,l&&a(n))}function u(){s&&s.forEach(function(n){n.step()})}var l,s,f,y,p=n;o(),t.prototype.load=function(n){i.call(this)},t.prototype.enable=function(n){c.call(this,this,n)},t.prototype.getIsEnabled=function(){return l},t.prototype.step=function(){u.call(this)}}n.Plugins.FallingThings.FallManager=t}(FunnyRain);